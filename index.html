<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rekap Daily Activity - Upload</title>
<link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f2f2f2; color:#222; }
.card { margin:20px auto; padding:18px; max-width:900px; background:#fff; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
h1,h2 { text-align:center; margin:8px 0; }
.brand-title { text-align:center; font-size:48px; font-family: 'Audiowide', cursive; font-weight:900; color:#2c3e50; letter-spacing:3px; margin:20px 0 10px; text-shadow:2px 2px 4px rgba(0,0,0,0.2); position:relative; }
.brand-title::before,.brand-title::after { content:""; display:block; height:3px; background:#2c3e50; margin:10px auto; width:60%; }
.brand-title .mirror { display:inline-block; transform: scaleX(-1); }
.brand-title .red { color:#e53935; }
.menu-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:12px; }
button { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-size:15px; color:#fff; box-shadow:0 5px 0 rgba(0,0,0,0.3); transition:all 0.2s ease; }
button:hover { transform:translateY(-2px); box-shadow:0 7px 0 rgba(0,0,0,0.35); }
button:active { transform:translateY(3px); box-shadow:0 2px 0 rgba(0,0,0,0.2); }
.btn-planogram{background:#2196F3;} .btn-rak{background:#4CAF50;} .btn-gudang{background:#FF9800;} .btn-display{background:#9C27B0;} .btn-expired{background:#F44336;} .btn-so{background:#00BCD4;} .btn-rekap{background:#6c757d;} .btn-archive{background:#795548;} .btn-back { background:#777; } .btn-send { background:#4CAF50; } .btn-reset { background:#e53935; }
.form-upload { text-align:center; }
.form-upload label { display:block; margin-top:10px; font-weight:600; }
.form-upload select, .form-upload input[type=file] { width:80%; margin-top:6px; padding:8px; border:1px solid #ccc; border-radius:6px; }
.action-row { display:flex; justify-content:space-between; margin-top:15px; }
#reports { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:15px; }
.photo-box { text-align:center; }
.photo-box img { width:120px; height:120px; object-fit:cover; border-radius:8px; display:block; margin:auto; }
#rekapTable table { width:100%; border-collapse:collapse; margin-top:15px; }
#rekapTable th, #rekapTable td { border:1px solid #ccc; padding:8px; text-align:center; font-size:14px; }
footer { text-align:center; margin-top:30px; font-size:16px; font-weight:bold; color:#444; letter-spacing:1px; }
</style>
</head>
<body>
<div class="brand-title">ENER<span class="red">O</span>J<span class="mirror">E</span></div>
<h1>üìä Rekap Daily Activity</h1>

<!-- MENU UTAMA -->
<div id="menu" class="card">
<h2>Pilih Menu</h2>
<div class="menu-grid">
<button class="btn-planogram" onclick="openCategory('PLANOGRAM')">üìå PLANOGRAM</button>
<button class="btn-rak" onclick="openCategory('KEBERSIHAN RAK')">üßπ KEBERSIHAN RAK</button>
<button class="btn-gudang" onclick="openCategory('GUDANG')">üì¶ GUDANG</button>
<button class="btn-display" onclick="openCategory('FULL DISPLAY')">üõí FULL DISPLAY</button>
<button class="btn-expired" onclick="openCategory('EXPIRED')">üìÖ EXPIRED</button>
<button class="btn-so" onclick="openCategory('SO PARTIAL')">üìã SO PARTIAL</button>
<button class="btn-rekap" onclick="openRekap()">üìë REKAPAN PERSONIL</button>
<button class="btn-archive" onclick="openArchive()">üìÇ Arsip Bulanan</button>
<button class="btn-reset" onclick="resetData()">üóëÔ∏è Hapus Semua Data</button>
</div>
</div>

<!-- KATEGORI -->
<div id="categoryPage" class="card" style="display:none;">
<h2 id="categoryTitle">Kategori</h2>
<div class="form-upload">
<label>Pilih Personil:</label>
<select id="personilSelect">
<option>Salwa</option><option>Dika</option><option>Elis</option><option>Nuri</option>
</select>
<label>Pilih Shift:</label>
<select id="shiftSelect">
<option>Shift 1</option><option>Shift 2</option>
</select>
<label>Upload Foto:</label>
<input type="file" id="imageInput" accept="image/*" capture="environment" multiple />
</div>
<div class="action-row">
<button class="btn-back" onclick="goBack()">‚¨ÖÔ∏è Back</button>
<button class="btn-send" onclick="saveReport()">üì§ Kirim</button>
</div>
<h3>Preview Upload</h3>
<div id="reports"></div>
</div>

<!-- REKAP PERSONIL -->
<div id="rekapPage" class="card" style="display:none;">
<h2>üìë Rekapan Upload Personil</h2>
<div id="rekapTable"></div>
<div style="text-align:center; margin-top:15px;">
<button class="btn-back" onclick="goBack()">‚¨ÖÔ∏è Back ke Menu Utama</button>
</div>
</div>

<!-- ARSIP -->
<div id="archivePage" class="card" style="display:none;">
<h2>üìÇ Arsip Bulanan</h2>
<div style="text-align:center; margin:10px 0;">
<label>Pilih Bulan:</label>
<input type="month" id="archiveMonth" onchange="renderArchive()">
</div>
<div class="table-wrapper"><div id="archiveTable"></div></div>
<div style="text-align:center; margin-top:15px;">
<button class="btn-back" onclick="goBack()">‚¨ÖÔ∏è Back ke Menu Utama</button>
</div>
</div>

<footer>JAGA SELALU INTEGRITAS DAN KERJA SAMA TIM</footer>

<script>
// =================== Fungsi Menu ===================
function openCategory(cat){menu.style.display="none";categoryPage.style.display="block";rekapPage.style.display="none";archivePage.style.display="none";categoryTitle.innerText=cat;renderReports();}
function openRekap(){menu.style.display="none";categoryPage.style.display="none";rekapPage.style.display="block";archivePage.style.display="none";renderRekap();}
function openArchive(){menu.style.display="none";categoryPage.style.display="none";rekapPage.style.display="none";archivePage.style.display="block";}
function goBack(){menu.style.display="block";categoryPage.style.display="none";rekapPage.style.display="none";archivePage.style.display="none";}

// =================== Upload ===================
function saveReport(){
  const files=document.getElementById("imageInput").files;
  const personil=document.getElementById("personilSelect").value;
  const shift=document.getElementById("shiftSelect").value;
  const category=categoryTitle.innerText;
  if(!files.length){alert("Pilih foto dulu!");return;}
  Array.from(files).forEach(file=>{
    const reader=new FileReader();
    reader.onload=e=>{
      google.script.run.withSuccessHandler(res=>{
        if(res.status==="ok"){renderReports();alert("Upload sukses!");}else{alert("Error: "+res.message);}
      }).uploadFile(e.target.result,file.name,file.type,personil,shift,category);
    };
    reader.readAsDataURL(file);
  });
}
function renderReports(){document.getElementById("reports").innerHTML="";}

// =================== REKAP ===================
function renderRekap(){
  google.script.run.withSuccessHandler(data=>{
    const categories=data.categories;
    const summary=data.summary;
    let html="<table><tr><th>Personil</th>";
    categories.forEach(c=>{html+="<th>"+c+"</th>";});
    html+="<th>Total</th></tr>";
    summary.forEach(row=>{
      html+="<tr><td>"+row.personil+"</td>";
      categories.forEach(c=>{
        let val=row[c]||0;
        let color="red";
        if(val>=1) color="green"; // >=1 upload dianggap 100%
        html+="<td style='background:"+color+";color:#fff;'>"+val+"</td>";
      });
      html+="<td>"+row.total+"</td></tr>";
    });
    html+="</table>";
    document.getElementById("rekapTable").innerHTML=html;
  }).getRekapSummary();
}

// =================== Arsip ===================
function renderArchive(){
  const month=document.getElementById("archiveMonth").value;
  if(!month){document.getElementById("archiveTable").innerHTML="<p style='text-align:center;'>Silakan pilih bulan.</p>";return;}
  google.script.run.withSuccessHandler(data=>{
    let html="<table><tr><th>Personil</th><th>Kategori</th><th>Shift</th><th>Tanggal</th></tr>";
    let found=false;
    data.forEach(r=>{
      const dt=new Date(r.datetime);
      const m=(dt.getMonth()+1).toString().padStart(2,"0");
      const y=dt.getFullYear();
      if(y+"-"+m===month){
        found=true;
        html+="<tr><td>"+r.personil+"</td><td>"+r.category+"</td><td>"+r.shift+"</td><td>"+r.datetime+"</td></tr>";
      }
    });
    html+="</table>";
    document.getElementById("archiveTable").innerHTML=found?html:"<p style='text-align:center;'>Tidak ada data pada bulan ini.</p>";
  }).getAllReports();
}

// =================== Reset ===================
function resetData(){
  if(confirm("Yakin ingin hapus semua data?")){
    google.script.run.withSuccessHandler(()=>{
      alert("Semua data berhasil dihapus!");
    }).resetAllData();
  }
}
</script>
</body>
</html>
